---
title: "Quick-Share v7 Summary Report"
format: 
  html:
    self-contained: false
    toc: true
    toc-depth: 2
---

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(knitr)
library(here)

REPO_ROOT <- here::here()
V7_ROOT <- file.path(REPO_ROOT, "quick_share_v7")
V7_QC <- file.path(V7_ROOT, "qc")
V7_ANALYSIS_READY <- file.path(V7_ROOT, "analysis_ready")

# Load QC data
expected_vs_found <- read_csv(file.path(V7_QC, "10_expected_vs_found_runs.csv"), show_col_types = FALSE)
auc_non_na_rates <- read_csv(file.path(V7_QC, "08_auc_non_na_rates.csv"), show_col_types = FALSE)
gate_rates <- read_csv(file.path(V7_QC, "02_gate_pass_rates_by_task_threshold.csv"), show_col_types = FALSE)
join_summary <- read_csv(file.path(V7_QC, "05_auc_join_match_summary.csv"), show_col_types = FALSE)

# Load analysis-ready datasets for counts
ch2_ready <- read_csv(file.path(V7_ANALYSIS_READY, "ch2_triallevel.csv"), show_col_types = FALSE)
ch3_ready <- read_csv(file.path(V7_ANALYSIS_READY, "ch3_triallevel.csv"), show_col_types = FALSE)
```

## Run Coverage Summary

```{r run-coverage}
run_coverage <- expected_vs_found %>%
  summarise(
    expected_runs_total = n(),
    runs_found_in_flat = sum(found_in_any_flat),
    runs_missing_in_flat = sum(!found_in_any_flat),
    runs_with_auc_features = sum(found_in_auc_features),
    runs_join_matched = sum(join_matched_any)
  ) %>%
  mutate(
    pct_found_in_flat = 100 * runs_found_in_flat / expected_runs_total,
    pct_with_auc = 100 * runs_with_auc_features / expected_runs_total,
    pct_join_matched = 100 * runs_join_matched / expected_runs_total
  )

kable(run_coverage, digits = 1, 
      caption = "Expected runs vs runs found in flat files vs runs with AUC features vs runs join matched")
```

## AUC Non-NA Rates

```{r auc-rates}
kable(auc_non_na_rates, digits = 1, 
      caption = "AUC non-NA rates: overall, by task, and conditional on run exists in flat")
```

## Gate Pass Rates

```{r gate-rates}
if ("pct_pass_050" %in% names(gate_rates)) {
  kable(gate_rates %>% select(task, threshold_050 = pct_pass_050, threshold_060 = pct_pass_060, 
                              threshold_070 = pct_pass_070, auc_ready = pct_auc_ready),
        digits = 1,
        caption = "Gate pass rates by task and threshold (MATLAB quality metrics + AUC flags)")
} else {
  kable(gate_rates, digits = 1,
        caption = "Gate pass rates by task and threshold")
}
```

## Analysis-Ready Dataset Summary

```{r analysis-summary}
analysis_summary <- tibble(
  dataset = c("ch2_triallevel", "ch3_triallevel"),
  n_trials = c(nrow(ch2_ready), nrow(ch3_ready)),
  pct_pupil_primary = c(
    100 * sum(ch2_ready$gate_pupil_primary, na.rm = TRUE) / nrow(ch2_ready),
    NA_real_
  ),
  pct_ddm_ready = c(
    NA_real_,
    100 * sum(ch3_ready$ddm_ready, na.rm = TRUE) / nrow(ch3_ready)
  )
)

kable(analysis_summary, digits = 1,
      caption = "Analysis-ready dataset summary")
```

## Conclusion / Decision

**1. Is this primarily a data availability issue?**
- `r sum(expected_vs_found$status == "MISSING_FLAT_RUN")` runs (`r sprintf("%.1f", 100*sum(expected_vs_found$status == "MISSING_FLAT_RUN")/nrow(expected_vs_found))`%) are missing from flat files.
- Match rate: `r sprintf("%.1f", join_summary$match_rate_pct)`% (`r join_summary$n_matched` / `r join_summary$n_total`).
- **Yes, this is primarily a data availability issue.** The low match rate is due to missing flat file coverage for many runs, not a join bug.

**2. Is AUC ready for inferential analyses?**
- Overall AUC availability (both total_auc and cog_auc): `r sprintf("%.1f", auc_non_na_rates %>% filter(task == "ALL") %>% pull(auc_available_both_pct))`%.
- For runs that exist in flat files: `r sprintf("%.1f", auc_non_na_rates %>% filter(grepl("run_in_flat", task)) %>% pull(auc_available_both_pct))`%.
- **AUC is available for a subset of trials.** Use `gate_pupil_primary` flag in Ch2 and `gate_auc_both` in Ch3 to identify defensible subsets.

**3. What to request from MATLAB pipeline?**
- Regenerate flat files for missing runs identified in `qc/10_expected_vs_found_runs.csv` where `status == "MISSING_FLAT_RUN"`.
- Priority: `r sum(expected_vs_found$status == "MISSING_FLAT_RUN")` runs across `r n_distinct(expected_vs_found %>% filter(status == "MISSING_FLAT_RUN") %>% select(sub, task))` subject-task combinations.

