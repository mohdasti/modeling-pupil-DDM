---
title: "Quick-Share v7 QC Summary"
format: 
  html:
    self-contained: false
    toc: true
    toc-depth: 2
---

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(knitr)
library(ggplot2)

REPO_ROOT <- here::here()
V7_ROOT <- file.path(REPO_ROOT, "quick_share_v7")
V7_MERGED <- file.path(V7_ROOT, "merged")
V7_QC <- file.path(V7_ROOT, "qc")
V7_ANALYSIS <- file.path(V7_ROOT, "analysis")

# Load data
merged <- read_csv(file.path(V7_MERGED, "BAP_triallevel_merged_v4.csv"), show_col_types = FALSE)
join_summary <- read_csv(file.path(V7_QC, "05_auc_join_match_summary.csv"), show_col_types = FALSE)
gate_rates <- read_csv(file.path(V7_QC, "02_gate_pass_rates_by_task_threshold.csv"), show_col_types = FALSE)
auc_missing <- read_csv(file.path(V7_QC, "03_auc_missingness_reasons.csv"), show_col_types = FALSE)
```

## Data Coverage

- **Total trials:** `r nrow(merged)`
- **Behavioral join rate:** `r round(100*sum(merged$has_behavioral_data, na.rm=TRUE)/nrow(merged), 1)`% (`r sum(merged$has_behavioral_data, na.rm=TRUE)` / `r nrow(merged)`)
- **AUC join match rate:** `r round(join_summary$match_rate_pct, 1)`% (`r join_summary$n_matched` / `r join_summary$n_total`)

## Gate Pass Rates (MATLAB Quality Metrics)

```{r gate-table}
gate_rates %>%
  select(task, threshold = pct_pass_050, `0.50` = pct_pass_050, `0.60` = pct_pass_060, `0.70` = pct_pass_070) %>%
  mutate(threshold = NULL) %>%
  kable(digits = 1, caption = "Pass rates by task and threshold (baseline_quality AND cog_quality)")
```

## AUC Availability

```{r auc-availability}
auc_by_task <- merged %>%
  filter(has_behavioral_data == TRUE) %>%
  group_by(task) %>%
  summarise(
    n_total = n(),
    n_auc = sum(auc_available == TRUE, na.rm = TRUE),
    pct_auc = round(100 * n_auc / n_total, 1),
    mean_n_valid_B0 = round(mean(n_valid_B0, na.rm = TRUE), 1),
    n_B0_ge_10 = sum(n_valid_B0 >= 10, na.rm = TRUE),
    .groups = "drop"
  )

kable(auc_by_task, caption = "AUC availability by task (behavioral-matched trials only)")
```

## Top AUC Missingness Reasons

```{r missingness}
auc_missing %>%
  arrange(desc(n_trials)) %>%
  head(10) %>%
  kable(caption = "Top missingness reasons")
```

## Decision Note: AUC Viability

```{r decision-note}
ch2_ready <- read_csv(file.path(V7_ANALYSIS, "ch2_analysis_ready_with_auc.csv"), show_col_types = FALSE)
ch3_ready <- read_csv(file.path(V7_ANALYSIS, "ch3_ddm_ready_with_auc.csv"), show_col_types = FALSE)

ch2_auc_rate <- round(100 * sum(ch2_ready$auc_available == TRUE, na.rm = TRUE) / nrow(ch2_ready), 1)
ch3_auc_rate <- round(100 * sum(ch3_ready$auc_available == TRUE, na.rm = TRUE) / nrow(ch3_ready), 1)
```

**AUC Availability After Gates:**
- **Chapter 2 (primary tier 0.60):** `r ch2_auc_rate`% (`r sum(ch2_ready$auc_available == TRUE, na.rm = TRUE)` / `r nrow(ch2_ready)`)
- **Chapter 3 (DDM-ready):** `r ch3_auc_rate`% (`r sum(ch3_ready$auc_available == TRUE, na.rm = TRUE)` / `r nrow(ch3_ready)`)

**Recommendation:**
`r if(ch2_auc_rate >= 25 && ch3_auc_rate >= 40) {"AUC is viable for both chapters. Proceed with AUC-based analyses."} else if(ch2_auc_rate >= 15 || ch3_auc_rate >= 25) {"AUC availability is marginal. Consider using MATLAB quality metrics as primary, with AUC as sensitivity analysis."} else {"AUC availability is too low. Use MATLAB quality metrics (baseline_quality, cog_quality) for primary analyses. AUC may be useful for exploratory analyses on high-quality subset."}`

